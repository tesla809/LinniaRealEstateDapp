<!DOCTYPE html>
<html lang="en">
<!--Plain Old HTML, CSS, JS to help you understand Linnia
We intend to remove as many barriers to learning Linnia as possible. See blog post for reasons.
Docs/blog: [add blog post] -->
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<title>Dapp- Add/View Records</title>
<!-- Note: css will be added later. Lets just focus on Linnia and Web3 code :)
Ignore the class definitions in the HTML -->
<!-- web3.js- an interface to access Ethereum blockchain Network
Docs: https://github.com/ethereum/web3.js/ -->
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

<!--linnia.js- Linnia Protocol's JS library for Ethereum blockchain
Docs: https://www.npmjs.com/package/@linniaprotocol/linnia-js,
https://github.com/ConsenSys/linnia-js,
https://github.com/ConsenSys/linnia-resources -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@linniaprotocol/linnia-js-script-tag@0.3.0/dist/index.min.js"></script>
<!-- Amazon AWS JS/Node SDK
release v2.326.0 downloaded from AWS website and placed into project.
Docs: https://aws.amazon.com/sdk-for-node-js/
File: https://github.com/aws/aws-sdk-js/releases -->
<script src="./aws-sdk.min.js"></script>
</head>
<body>
  <!--fix code to regular old html -->
  <!--header-->
  <h1 class="header-title" id="app-header-title">Real Estate Dapp</h1>
   <div class="header">
     <a href='index.html' class="header-div"><span>View/Add Records</span></a>
     <a href='permissions.html' class="header-div"><span>View/Add Permissions</span></a>
     <a href='thirdparty.html' class="header-div"><span>Third Party</span></a>
   </div>

  <!--view/add record portion-->
  <div>
  <div class="jumbotron text-center">
      <h1>View/Add Records</h1>
      <p>User Input</p>
  </div>

  <div class="container">
  <form id="upload-form">
      <div class="form-group row">
        <label class="col-sm-2 col-form-label">Name</label>
        <div class="col-sm-10">
          <input
            placeholder="Your Legal Name"
            class="view-add-form-text-input form-control"
            id="name"
            required />
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-2 col-form-label">Credit Score</label>
        <div class="col-sm-10">
          <input
            placeholder="Equihax Credit Score"
            class="view-add-form-text-input form-control"
            id="credit-score"/>
        </div>
      </div>
        <div class="form-group" id="upload-div">
            <label htmlFor="exampleInputFile">Upload W-2 Tax Form</label>
            <input type="file" class="form-control-file" id="exampleInputFile" aria-describedby="fileHelp"/>
            <br />
            <small id="fileHelp" class="form-text text-muted">Please upload your most recent tax form</small>
        </div>
        <button loading='' class="btn btn-primary" id="submit-form-button">Add New Record</button>
    </form>
  </div>
  </div>

  <script>
    console.log('Testing');
    // IMPORTANT:
    // Make sure you (and users) have MetaMask on web browser first
    // docs: [add docs here]
    // Make sure users are registered w/ Linnia Faucet and get encryption keys.
    // DONT LOSE KEYS- no way to recover.
    // docs: [add post section here]

    // Setup of Linnia/web3
    // docs: https://github.com/ConsenSys/linnia-js
    // const Web3 = require("web3"); /* not needed since import up top */
    // const Linnia = require("@linniaprotocol/linnia-js"); /* not needed since import up top */
    const web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
    const linnia = new Linnia(web3);

    // testing- loading?
    console.log(Web3);
    console.log(Linnia);
    console.log(AWS);

    // AWS set up
    // See AWS setup post: [add post here]
    const s3 = new AWS.S3({region: 'us-east-ohio'});
    const YOUR_BUCKET_NAME = 'linnia-tutorial';
    let YOUR_DATA = ''; // fetch data from upload.
    let YOUR_ENCRYPTED_DATA = ''; // use linnia util to encrypt?

    // dataHash described: [add description]
    let dataHash = '';
    
    // metaData described: [add description]
    let metaData = '';

    const params = {
      Body: YOUR_ENCRYPTED_DATA,
      Bucket: YOUR_BUCKET_NAME,
      Key: dataHash, // the dataHash of your data
      ServerSideEncryption: "AES256", // (optional): extra encryption at rest if you choose
      ACL: 'public-read', // public read so anyone with decryption keys can read
      Tagging: metaData // (optional): and metaData you wish to
    }

    // ----
    // helper functions
    // regex
    // accept only three numbers as credit score field
    const validateCreditScoreInput = () => {
      const creditScoreRegex = /\b\d{1,3}\b/g
      const inputValue = document.querySelector("#credit-score").value;
      parseInt(inputValue);
      let inputResult = creditScoreRegex.test(inputValue);
      let inputResultOutput = inputResult ? true : false;

      // logic is: go ahead if true, if not, don't.
      return inputResultOutput;
    }

    // add event listeners to multiple elements in a class
    // You need to add the event listener each element in that class
    const addEventListenerToClasses = (arr, e, eventHandlerFunction) => {
      for (var i = 0; i < arr.length; i++) {
        arr[i].addEventListener(e, eventHandlerFunction, false);
      }
    }

    // need function that captures data
    // So upload function is really Encrypt and Append:
    //
    // ---
    // Linnia functions
    const addNewRecord = () => {
      let name = document.querySelector('#name').value;
      let creditScore = document.querySelector('#credit-score').value;
      const goodInputTests = (name && creditScore) != '';

      let messageOutput = goodInputTests ? 'yes' : 'no';
      console.log(messageOutput);

      // send record to storage
      // add logic here
      // Need to encrypt
      // as a test just encrypt and console.log it

      // Need to get dataHash here?
      // check white paper.
    }

    // ---
    // event handlers
    // prevents default

    const handleSubmitFormButton = (event) => {
      console.log('submitted!');
      let validInput = validateCreditScoreInput();
      if (validInput) {
        addNewRecord();
      } else {
        alert('Not Valid Input. Try again');
      }

      // prevent refresh
      event.preventDefault();
    }

    // Form error message
    const handleErrorMessage = (e) => {
      return 'Error on submitting form' + e;
    }

    // handles input key press
    const handleInputKeyPress = (event) => {
      console.log(event.key);
    }

    // ---
    // eventListeners
    // Input onchange message
    // querySelectorAll gets all the elements with the similar class
    // querySelector only gets the first element with said class
    // Why this function? Not sure...
    const viewAddFormTextInputDivs = document.querySelectorAll(".view-add-form-text-input");
    addEventListenerToClasses(viewAddFormTextInputDivs, 'keypress', handleInputKeyPress);

    // upload form- onsubmit
    document.querySelector("#submit-form-button")
      .addEventListener("click", handleSubmitFormButton, false);

    // upload form- onerror
    // double check this works
    document.querySelector("#upload-form")
      .addEventListener("onerror", handleErrorMessage, false);
  </script>
</body>
</html>
